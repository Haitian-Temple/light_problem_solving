<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ä¸‰èŠæµ·å¤©å®« - äº”å¹´åƒå²å·¡ç¯åå†Œè§£æƒ‘æŠ¥å</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        /* é‡ç½®æ ·å¼ */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }
        
        /* å…¨å±€æ ·å¼ */
        html, body {
            height: 100%;
            width: 100%;
            font-family: 'Microsoft JhengHei', 'PingFang TC', 'Heiti TC', sans-serif;
            background: #f8f4e9;
            color: #333;
            line-height: 1.6;
            font-size: 20px; /* é»˜è®¤å¤§å­—ä½“ï¼Œé€‚åˆè€å¹´äºº */
        }
        
        /* å®¹å™¨å¸ƒå±€ */
        .container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            max-width: 100%;
            margin: 0 auto;
            background: white;
            box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
        }
        
        /* é¡¶éƒ¨LOGOå’Œå¯¼èˆªåŒºåŸŸ */
        .header {
            background: linear-gradient(135deg, #8B4513 0%, #D2691E 100%);
            color: white;
            padding: 25px 20px;
            position: relative;
            overflow: hidden;
        }
        
        .header-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            position: relative;
            z-index: 2;
        }
        
        .logo-section {
            display: flex;
            align-items: center;
            justify-content: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .logo-img {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            background: white;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 20px;
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.3);
            border: 5px solid #FFD700;
        }
        
        .logo-img i {
            font-size: 60px;
            color: #8B4513;
        }
        
        .temple-title {
            text-align: center;
        }
        
        .temple-title h1 {
            font-size: 2.8rem;
            margin-bottom: 10px;
            font-weight: 700;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        
        .temple-title p {
            font-size: 1.6rem;
            opacity: 0.9;
        }
        
        /* ä¸»å†…å®¹åŒºåŸŸ */
        .main-content {
            flex: 1;
            padding: 25px;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        
        /* åº”ç”¨å®¹å™¨ */
        .app-container {
            width: 100%;
            max-width: 800px;
            background: #F5F5DC;
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .app-header {
            background: #8B4513;
            color: white;
            padding: 20px;
            text-align: center;
            border-radius: 12px;
            margin-bottom: 25px;
        }
        
        .app-header h2 {
            font-size: 2.2rem;
            margin-bottom: 10px;
        }
        
        .app-header p {
            font-size: 1.4rem;
            opacity: 0.9;
        }
        
        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 25px;
        }
        
        .form-label {
            display: block;
            margin-bottom: 15px;
            font-weight: 600;
            color: #8B4513;
            font-size: 1.4rem;
        }
        
        .form-input {
            width: 100%;
            padding: 20px;
            font-size: 1.4rem;
            border: 3px solid #D2691E;
            border-radius: 12px;
            background: white;
            min-height: 70px;
        }
        
        .form-input:focus {
            outline: none;
            border-color: #8B4513;
            box-shadow: 0 0 10px rgba(139, 69, 19, 0.3);
        }
        
        .light-type-display {
            background: #e8f5e8;
            border: 3px solid #228B22;
            color: #228B22;
            font-weight: 600;
            text-align: center;
            padding: 20px;
            border-radius: 12px;
            font-size: 1.6rem;
            min-height: 90px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
        }
        
        .notes-section {
            margin-top: 20px;
        }
        
        .notes-title {
            font-size: 1.4rem;
            font-weight: 600;
            color: #8B4513;
            margin-bottom: 15px;
            text-align: center;
        }
        
        .notes-tags {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-bottom: 20px;
        }
        
        .note-tag {
            background: white;
            border: 3px solid #D2691E;
            border-radius: 25px;
            padding: 15px 20px;
            font-size: 1.3rem;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.15s;
            user-select: none;
            min-width: 100px;
            text-align: center;
        }
        
        .note-tag.active {
            background: #D2691E;
            color: white;
        }
        
        .action-buttons {
            display: flex;
            flex-direction: column;
            gap: 15px;
            margin-top: 25px;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 22px;
            border: none;
            border-radius: 12px;
            font-size: 1.5rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.15s;
            min-height: 75px;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
        }
        
        .btn-primary {
            background: #228B22;
            color: white;
        }
        
        .btn-primary:active {
            background: #1E7A1E;
        }
        
        .btn-secondary {
            background: #D2691E;
            color: white;
        }
        
        .btn-secondary:active {
            background: #B85C14;
        }
        
        .btn-warning {
            background: #ff9800;
            color: white;
        }
        
        .btn-warning:active {
            background: #f57c00;
        }
        
        .btn-danger {
            background: #e74c3c;
            color: white;
        }
        
        .btn-danger:active {
            background: #c0392b;
        }
        
        .btn-disabled {
            background: #cccccc !important;
            color: #666666 !important;
            cursor: not-allowed !important;
        }
        
        /* ç­‰å¾…åŒºåŸŸ */
        .waiting-area {
            background: white;
            border-radius: 12px;
            padding: 25px;
            margin-top: 25px;
            display: none;
            flex: 1;
            overflow-y: auto;
        }
        
        .queue-info {
            text-align: center;
            margin-bottom: 25px;
        }
        
        .queue-number {
            font-size: 4rem;
            color: #8B4513;
            font-weight: 700;
            margin: 20px 0;
        }
        
        .status-badge {
            display: inline-block;
            padding: 15px 25px;
            border-radius: 25px;
            color: white;
            font-weight: 600;
            margin: 15px 0;
            font-size: 1.4rem;
        }
        
        .status-pending {
            background: #FF8C00;
        }
        
        .status-waiting {
            background: #FF8C00;
        }
        
        .status-serving {
            background: #8B4513;
        }
        
        .status-completed {
            background: #6c757d;
        }
        
        .status-rejected {
            background: #e74c3c;
        }
        
        .status-cancelled {
            background: #6c757d;
        }
        
        .meeting-link {
            display: block;
            text-align: center;
            padding: 22px;
            background: #228B22;
            color: white;
            text-decoration: none;
            border-radius: 12px;
            font-size: 1.5rem;
            margin-top: 20px;
            font-weight: 600;
            min-height: 75px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }
        
        .meeting-link.disabled {
            background: #cccccc !important;
            color: #666666 !important;
            cursor: not-allowed !important;
            pointer-events: none;
        }
        
        .meeting-link.active {
            background: #228B22;
            color: white;
        }
        
        /* ä¼šè®®å®¤æŒ‰é’®è„‰å†²åŠ¨ç”» */
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(34, 139, 34, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(34, 139, 34, 0); }
            100% { box-shadow: 0 0 0 0 rgba(34, 139, 34, 0); }
        }
        
        .meeting-link.pulse {
            animation: pulse 2s infinite;
        }
        
        /* é¡µè„š */
        .footer {
            background: #8B4513;
            color: white;
            padding: 25px;
            text-align: center;
            margin-top: auto;
        }
        
        .footer-content {
            max-width: 800px;
            margin: 0 auto;
        }
        
        .footer p {
            margin-bottom: 12px;
            font-size: 1.3rem;
        }
        
        .footer a {
            color: #FFD700;
            text-decoration: none;
        }
        
        .footer a:hover {
            text-decoration: underline;
        }
        
        .footer-divider {
            margin: 15px 0;
            height: 2px;
            background: rgba(255, 255, 255, 0.3);
        }
        
        /* å·¥å…·æŒ‰é’® */
        .text-size-toggle {
            position: fixed;
            bottom: 25px;
            right: 25px;
            background: #8B4513;
            color: white;
            border: none;
            border-radius: 50%;
            width: 70px;
            height: 70px;
            font-size: 1.8rem;
            cursor: pointer;
            box-shadow: 0 6px 15px rgba(0,0,0,0.2);
            z-index: 1000;
            border: 3px solid #FFD700;
        }
        
        /* é€šçŸ¥æ ·å¼ */
        .notification-toast {
            position: fixed;
            top: 25px;
            left: 50%;
            transform: translateX(-50%);
            background: #333;
            color: white;
            padding: 20px 30px;
            border-radius: 10px;
            z-index: 1002;
            box-shadow: 0 6px 15px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease-out;
            font-size: 1.3rem;
        }
        
        @keyframes slideIn {
            from { transform: translate(-50%, -100%); opacity: 0; }
            to { transform: translate(-50%, 0); opacity: 1; }
        }
        
        /* è£…é¥°å…ƒç´  */
        .decoration {
            position: absolute;
            opacity: 0.1;
            z-index: 1;
        }
        
        .decoration-1 {
            top: 15px;
            left: 15px;
            font-size: 120px;
            color: white;
        }
        
        .decoration-2 {
            bottom: 15px;
            right: 15px;
            font-size: 100px;
            color: white;
        }
        
        /* å“åº”å¼è®¾è®¡ */
        @media (max-width: 768px) {
            .main-content {
                padding: 15px;
            }
            
            .logo-section {
                flex-direction: column;
            }
            
            .logo-img {
                margin: 10px 0;
                width: 100px;
                height: 100px;
            }
            
            .logo-img i {
                font-size: 50px;
            }
            
            .temple-title h1 {
                font-size: 2.2rem;
            }
            
            .temple-title p {
                font-size: 1.3rem;
            }
            
            .app-container {
                padding: 20px;
            }
            
            .notes-tags {
                gap: 10px;
            }
            
            .note-tag {
                min-width: 90px;
                padding: 12px 18px;
            }
        }
        
        @media (max-width: 480px) {
            .header {
                padding: 20px 15px;
            }
            
            .temple-title h1 {
                font-size: 1.8rem;
            }
            
            .temple-title p {
                font-size: 1.2rem;
            }
            
            .app-container {
                padding: 15px;
            }
            
            .form-input, .btn, .meeting-link {
                min-height: 65px;
            }
        }
        
        /* å°å­—ä½“æ¨¡å¼ */
        .small-text {
            font-size: 16px !important;
        }
        
        .small-text .form-input,
        .small-text .btn,
        .small-text .alert,
        .small-text .form-label,
        .small-text .notes-title {
            font-size: 1.1rem !important;
        }
        
        .small-text .note-tag {
            font-size: 1rem;
            padding: 10px 15px;
        }
        
        .small-text .app-header h2 {
            font-size: 1.8rem;
        }
        
        .small-text .app-header p {
            font-size: 1.2rem;
        }
        
        .small-text .queue-number {
            font-size: 3rem;
        }
        
        .small-text .status-badge {
            font-size: 1.2rem;
            padding: 12px 20px;
        }
        
        .small-text .light-type-display {
            font-size: 1.3rem;
        }
        
        .small-text .footer p {
            font-size: 1rem;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- é¡¶éƒ¨LOGOå’Œå¯¼èˆª -->
        <header class="header">
            <div class="decoration decoration-1">
                <i class="fas fa-temple-buddhist"></i>
            </div>
            <div class="decoration decoration-2">
                <i class="fas fa-praying-hands"></i>
            </div>
            <div class="header-content">
                <div class="logo-section">
                    <div class="logo-img">
                        <i class="fas fa-temple-buddhist"></i>
                    </div>
                    <div class="temple-title">
                        <h1>ä¸‰èŠæµ·å¤©å®«</h1>
                        <p>äº”å¹´åƒå²å·¡å®‰ç¯èµç¦</p>
                    </div>
                    <div class="logo-img">
                        <i class="fas fa-praying-hands"></i>
                    </div>
                </div>
            </div>
        </header>
        
        <!-- ä¸»å†…å®¹åŒºåŸŸ -->
        <main class="main-content">
            <!-- åº”ç”¨å®¹å™¨ -->
            <div class="app-container">
                <div class="app-header">
                    <h2><i>äº”å¹´åƒå²-å·¡å®‰ç¯åå†Œ</i></h2>
                    <p>è§£æƒ‘çº¿ä¸ŠæŠ¥åæœåŠ¡</p>
                </div>
                
                <div class="content">
                    <div id="application-form">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-user"></i> çœŸå®å§“å(é™æœ¬äºº)
                            </label>
                            <input type="text" id="client-name" class="form-input" placeholder="è¯·è¾“å…¥æ‚¨çš„çœŸå®å§“å" required>
                        </div>
                        
                        <div class="form-group">
                            <label class="form-label">
                                <i class="fas fa-lightbulb"></i> ä»Šæ—¥è§£æƒ‘ç¯å
                            </label>
                            <div id="light-type-display" class="light-type-display">
                                <i class="fas fa-spinner fa-spin"></i> è½½å…¥ä¸­...
                            </div>
                        </div>
                        
                        <div class="notes-section">
                            <div class="notes-title">
                                <i class="fas fa-sticky-note"></i> æ³¨æ„äº‹é¡¹ (å¯å¤é€‰)
                            </div>
                            <div class="notes-tags" id="notes-tags">
                                <div class="note-tag" data-value="èº«ä½“">èº«ä½“</div>
                                <div class="note-tag" data-value="ç¡çœ ">ç¡çœ </div>
                                <div class="note-tag" data-value="å¤–å‡º">å¤–å‡º</div>
                                <div class="note-tag" data-value="æ°´è¾¹">æ°´è¾¹</div>
                                <div class="note-tag" data-value="å…¶ä»–">å…¶ä»–</div>
                            </div>
                        </div>
                        
                        <div class="action-buttons">
                            <button class="btn btn-primary" id="submit-btn">
                                <i class="fas fa-paper-plane"></i> æäº¤æŠ¥å
                            </button>
                        </div>
                    </div>
                    
                    <div id="alert-area"></div>
                    
                    <div class="waiting-area" id="waiting-area">
                        <div class="queue-info">
                            <h3><i class="fas fa-list-ol"></i> æ‚¨çš„ç”³è¯·çŠ¶æ€</h3>
                            <div class="queue-number" id="queue-number">-</div>
                            <div class="status-badge" id="status-badge">å®¡æ ¸ä¸­</div>
                            <div id="current-position-info" style="margin-top: 20px; color: #666; font-size: 1.3rem;"></div>
                        </div>
                        
                        <a id="meeting-link" class="meeting-link disabled" target="_blank">
                            <i class="fas fa-video"></i> è¿›å…¥ Line ä¼šè®®å®¤
                        </a>
                        
                        <div class="cancel-section" id="cancel-section" style="display: none; margin-top: 25px;">
                            <button class="btn btn-danger" id="cancel-btn">
                                <i class="fas fa-times-circle"></i> å–æ¶ˆæŠ¥å
                            </button>
                        </div>
                        
                        <div id="queue-list-container" style="display: none; margin-top: 25px;">
                            <h4><i class="fas fa-users"></i> ç­‰å¾…åå•</h4>
                            <div class="queue-list" id="queue-list">
                                <div id="queue-list-content">
                                    <!-- ç­‰å¾…åå•å°†åŠ¨æ€ç”Ÿæˆ -->
                                </div>
                            </div>
                        </div>

                        <div class="retry-section" id="retry-section" style="display: none; margin-top: 25px;">
                            <button class="btn btn-warning" id="retry-btn">
                                <i class="fas fa-redo"></i> é‡æ–°æŠ¥å
                            </button>
                        </div>
                        
                        <div class="auto-refresh-info" id="auto-refresh-info" style="text-align: center; color: #666; font-size: 1.1rem; margin-top: 15px; padding: 10px; background: #f8f9fa; border-radius: 8px;">
                            <i class="fas fa-sync-alt"></i> çŠ¶æ€è‡ªåŠ¨æ›´æ–°ä¸­...
                        </div>
                    </div>
                </div>
            </div>
        </main>
        
        <!-- é¡µè„š -->
        <footer class="footer">
            <div class="footer-content">
                <p><i class="fas fa-map-marker-alt"></i> æ–°åŒ—å¸‚ä¸‰èŠåŒºæµ…æ°´æ¹¾è¡—11-1å·1æ¥¼Eæ ‹</p>
                <p><i class="fas fa-phone"></i> æœåŠ¡ä¸“çº¿ï¼š0961-321-166</p>
                <div class="footer-divider"></div>
                <p>äº”å¹´åƒå²å·¡å®‰ç¯èµç¦ &copy; 2025 ä¸‰èŠæµ·å¤©å®« ç‰ˆæƒæ‰€æœ‰</p>
            </div>
        </footer>
    </div>
    
    <!-- å­—ä½“å¤§å°åˆ‡æ¢æŒ‰é’® -->
    <button class="text-size-toggle" id="text-size-toggle" title="è°ƒæ•´å­—ä½“å¤§å°">
        <i class="fas fa-text-height"></i>
    </button>

    <!-- è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡† -->
    <div id="custom-confirm" class="custom-confirm" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 10000; padding: 20px;">
        <div class="confirm-content" style="background: white; border-radius: 15px; padding: 30px; max-width: 500px; width: 100%; text-align: center; box-shadow: 0 10px 40px rgba(0,0,0,0.3);">
            <div class="confirm-message" id="confirm-message" style="font-size: 1.5rem; margin-bottom: 30px; color: #333; line-height: 1.6;">ç¡®å®šè¦å–æ¶ˆæŠ¥åå—ï¼Ÿå–æ¶ˆåå°†æ— æ³•æ¢å¤æ‚¨çš„æ’é˜Ÿä½ç½®ã€‚</div>
            <div class="confirm-buttons" style="display: flex; gap: 15px; justify-content: center;">
                <button class="confirm-btn cancel" id="confirm-cancel" style="padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.3rem; cursor: pointer; min-width: 120px; transition: all 0.15s; background: #6c757d; color: white;">å–æ¶ˆ</button>
                <button class="confirm-btn confirm" id="confirm-ok" style="padding: 15px 30px; border: none; border-radius: 10px; font-size: 1.3rem; cursor: pointer; min-width: 120px; transition: all 0.15s; background: #e74c3c; color: white;">ç¡®å®š</button>
            </div>
        </div>
    </div>

    <!-- éšè—çš„éŸ³é¢‘å…ƒç´ ç”¨äºæ’­æ”¾é€šçŸ¥å£°éŸ³ -->
    <audio id="notification-sound" preload="auto">
        <source src="data:audio/wav;base64,UklGRigAAABXQVZFZm10IBAAAAABAAEARKwAAIhYAQACABAAZGF0YQQAAAAAAA==" type="audio/wav">
    </audio>

    <script>
        // åˆå§‹åŒ–å˜é‡
        let currentClient = null;
        let refreshInterval = null;
        let hasMeetingEnded = false;
        let selectedNotes = [];
        let isLargeText = true; // é»˜è®¤ä½¿ç”¨å¤§å­—ä½“
        let pendingConfirmCallback = null;
        let notificationCheckInterval = null;
        let lastKnownStatus = '';
        let lastKnownQueueNum = 0;
        let isNotificationSupported = false;
        let notificationPermission = 'default';
        let titleBlinkInterval = null;
        let originalTitle = '';
        
        // æ£€æŸ¥æµè§ˆå™¨é€šçŸ¥æ”¯æŒ
        function checkNotificationSupport() {
            isNotificationSupported = 'Notification' in window;
            if (isNotificationSupported) {
                notificationPermission = Notification.permission;
            }
            return isNotificationSupported;
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            // æ£€æµ‹æ˜¯å¦åœ¨iframeä¸­è¿è¡Œï¼ˆGoogle SitesåµŒå…¥ï¼‰
            if (window.self !== window.top) {
                document.body.classList.add('embedded');
            }
            
            // æ£€æŸ¥é€šçŸ¥æ”¯æŒ
            checkNotificationSupport();
            
            initializeApp();
        });
        
        function initializeApp() {
            // åº”ç”¨å­—ä½“è®¾å®š
            if (!isLargeText) {
                document.body.classList.add('small-text');
                updateTextSizeToggle(false);
            }
            
            setupEventListeners();
            loadSettings();
            
            // ä»æœ¬åœ°å‚¨å­˜æ¢å¤å®¢æˆ·èµ„æ–™
            const storedClient = localStorage.getItem('clientData');
            if (storedClient) {
                try {
                    const clientData = JSON.parse(storedClient);
                    const clientName = document.getElementById('client-name');
                    
                    if (clientData.name) {
                        clientName.value = clientData.name;
                    }
                    
                    // å¦‚æœæœ‰æœªå®Œæˆçš„ç”³è¯·ï¼Œç›´æ¥æ˜¾ç¤ºç­‰å¾…çŠ¶æ€
                    if (clientData.clientId && clientData.status &&
                        clientData.status !== 'ç»“æŸ' && clientData.status !== 'æœªé€šè¿‡' && clientData.status !== 'å·²å–æ¶ˆ') {
                        currentClient = clientData;
                        showWaitingState(clientData);
                        startStatusRefresh();
                        startNotificationCheck();
                    }
                } catch (e) {
                    console.error('æ¢å¤å®¢æˆ·èµ„æ–™å¤±è´¥:', e);
                    localStorage.removeItem('clientData');
                }
            }

            // è®¾ç½®é¡µé¢å¯è§æ€§ç›‘å¬
            setupPageVisibilityListener();
            
            // è¯·æ±‚é€šçŸ¥æƒé™
            requestNotificationPermission();
        }

        // æ–°å¢ï¼šè¯·æ±‚é€šçŸ¥æƒé™
        function requestNotificationPermission() {
            if (!isNotificationSupported) return;
            
            if (notificationPermission === 'default') {
                // åœ¨ç”¨æˆ·äº’åŠ¨åè¯·æ±‚æƒé™
                document.getElementById('submit-btn').addEventListener('click', function() {
                    if (notificationPermission === 'default') {
                        Notification.requestPermission().then(function(permission) {
                            notificationPermission = permission;
                            if (permission === 'granted') {
                                console.log('é€šçŸ¥æƒé™å·²æˆäºˆ');
                            }
                        });
                    }
                }, { once: true });
            }
        }

        // æ–°å¢ï¼šé¡µé¢å¯è§æ€§ç›‘å¬
        function setupPageVisibilityListener() {
            document.addEventListener('visibilitychange', function() {
                if (!document.hidden && currentClient && currentClient.clientId) {
                    // é¡µé¢é‡æ–°å¯è§æ—¶ï¼Œç«‹å³æ£€æŸ¥çŠ¶æ€
                    loadWaitingQueue();
                    // åœæ­¢æ ‡é¢˜é—ªçƒ
                    stopTitleBlink();
                }
            });
        }
        
        function setupEventListeners() {
            document.getElementById('submit-btn').addEventListener('click', submitApplication);
            document.getElementById('text-size-toggle').addEventListener('click', toggleTextSize);
            document.getElementById('retry-btn').addEventListener('click', retryApplication);
            document.getElementById('cancel-btn').addEventListener('click', showCancelConfirm);
            
            // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†äº‹ä»¶
            document.getElementById('confirm-cancel').addEventListener('click', hideConfirmDialog);
            document.getElementById('confirm-ok').addEventListener('click', function() {
                if (pendingConfirmCallback) {
                    pendingConfirmCallback();
                }
                hideConfirmDialog();
            });
            
            document.getElementById('client-name').addEventListener('keypress', function(e) {
                if (e.key === 'Enter') submitApplication();
            });
            
            // æ³¨æ„äº‹é¡¹æ ‡ç­¾ç‚¹å‡»äº‹ä»¶
            document.querySelectorAll('.note-tag').forEach(tag => {
                tag.addEventListener('click', function() {
                    this.classList.toggle('active');
                    const value = this.dataset.value;
                    
                    if (this.classList.contains('active')) {
                        if (!selectedNotes.includes(value)) {
                            selectedNotes.push(value);
                        }
                    } else {
                        const index = selectedNotes.indexOf(value);
                        if (index > -1) {
                            selectedNotes.splice(index, 1);
                        }
                    }
                });
            });
        }

        // æ–°å¢ï¼šæ£€æŸ¥å®¢æˆ·çŠ¶æ€
        function checkClientStatusOnLoad() {
            const storedClient = localStorage.getItem('clientData');
            if (storedClient) {
                const clientData = JSON.parse(storedClient);
                if (clientData.clientId) {
                    google.script.run
                        .withSuccessHandler(result => {
                            if (result.exists) {
                                currentClient = {
                                    name: result.client.name,
                                    clientId: result.client.clientId,
                                    status: result.client.status,
                                    lightType: result.client.lightType
                                };
                                showWaitingState(currentClient);
                                startStatusRefresh();
                                startNotificationCheck();
                            }
                        })
                        .withFailureHandler(error => {
                            console.error('æ£€æŸ¥å®¢æˆ·çŠ¶æ€å¤±è´¥:', error);
                        })
                        .checkClientStatus(clientData.clientId);
                }
            }
        }

        // æ–°å¢ï¼šé€šçŸ¥æ£€æŸ¥
        function startNotificationCheck() {
            if (notificationCheckInterval) {
                clearInterval(notificationCheckInterval);
            }
            notificationCheckInterval = setInterval(() => {
                if (document.hidden && currentClient && currentClient.clientId) {
                    // é¡µé¢ä¸å¯è§æ—¶ï¼Œæ£€æŸ¥çŠ¶æ€å˜åŒ–
                    loadWaitingQueueForNotification();
                }
            }, 10000); // æ¯10ç§’æ£€æŸ¥ä¸€æ¬¡
        }

        function loadWaitingQueueForNotification() {
            if (!currentClient) return;
            
            google.script.run
                .withSuccessHandler(data => {
                    if (data.client) {
                        checkForStatusChange(data.client);
                    }
                })
                .getWaitingList(currentClient.name, currentClient.clientId);
        }

        function checkForStatusChange(client) {
            const statusChanged = lastKnownStatus !== client.status;
            const queueChanged = lastKnownQueueNum !== (client.queue_num || 0);
            
            if (statusChanged || queueChanged) {
                // å¦‚æœçŠ¶æ€å˜ä¸ºæœåŠ¡ä¸­ï¼Œè§¦å‘å¼ºåŠ›é€šçŸ¥
                if (client.status === 'æœåŠ¡ä¸­' && lastKnownStatus !== 'æœåŠ¡ä¸­') {
                    triggerPowerfulNotification(client);
                } else if (queueChanged) {
                    // é˜Ÿåˆ—ä½ç½®å˜åŒ–æ—¶å‘é€ä¸€èˆ¬é€šçŸ¥
                    showBrowserNotification(client);
                }
                
                lastKnownStatus = client.status;
                lastKnownQueueNum = client.queue_num || 0;
            }
        }

        // æ–°å¢ï¼šå¼ºåŠ›é€šçŸ¥ç³»ç»Ÿ
        function triggerPowerfulNotification(client) {
            // 1. æµè§ˆå™¨é€šçŸ¥
            showBrowserNotification(client, true);
            
            // 2. é¡µé¢æ ‡é¢˜é—ªçƒ
            startTitleBlink();
            
            // 3. æ’­æ”¾é€šçŸ¥å£°éŸ³
            playNotificationSound();
            
            // 4. éœ‡åŠ¨ï¼ˆå¦‚æœæ”¯æŒï¼‰
            if ('vibrate' in navigator) {
                navigator.vibrate([200, 100, 200]);
            }
            
            // 5. æ˜¾ç¤ºé¡µé¢å†…é€šçŸ¥
            showInPageNotification('è½®åˆ°æ‚¨äº†ï¼è¯·å‡†å¤‡è¿›å…¥ä¼šè®®å®¤');
        }

        function showBrowserNotification(client, isUrgent = false) {
            if (!isNotificationSupported || notificationPermission !== 'granted') {
                return;
            }

            let title = 'æµ·å¤©å®«å·¡ç¯ç³»ç»Ÿ';
            let body = '';
            let options = {
                icon: 'https://cdn.jsdelivr.net/gh/feathericons/feather@master/icons/bell.svg',
                badge: 'https://cdn.jsdelivr.net/gh/feathericons/feather@master/icons/check-circle.svg',
                tag: 'haitian-temple-notification'
            };
            
            if (client.status === 'æœåŠ¡ä¸­') {
                title = 'ğŸš¨ è½®åˆ°æ‚¨äº†ï¼';
                body = 'è¯·ç«‹å³è¿›å…¥ä¼šè®®å®¤è¿›è¡Œè§£æƒ‘';
                options.requireInteraction = true;
                options.actions = [
                    {
                        action: 'join',
                        title: 'è¿›å…¥ä¼šè®®å®¤'
                    }
                ];
            } else if (client.status === 'ç­‰å¾…ä¸­') {
                if (client.queue_num === 1) {
                    title = 'âš ï¸ å³å°†è½®åˆ°æ‚¨';
                    body = 'æ‚¨æ˜¯å½“å‰ç¬¬ä¸€ä½ï¼Œè¯·å‡†å¤‡';
                } else if (client.queue_num <= 3) {
                    title = 'â° å³å°†è½®åˆ°æ‚¨';
                    body = `æ‚¨å‰é¢è¿˜æœ‰ ${client.queue_num - 1} ä½ç­‰å¾…è€…`;
                } else {
                    title = 'ğŸ“‹ æ’é˜ŸçŠ¶æ€æ›´æ–°';
                    body = `æ‚¨çš„æ’é˜Ÿå·ç : ${client.queue_num}`;
                }
            }

            const notification = new Notification(title, options);

            notification.onclick = function() {
                window.focus();
                notification.close();
                if (client.status === 'æœåŠ¡ä¸­') {
                    loadMeetingLink();
                }
            };

            // å¦‚æœæ˜¯æœåŠ¡ä¸­é€šçŸ¥ï¼Œè®¾ç½®æ›´é•¿çš„æ˜¾ç¤ºæ—¶é—´
            const timeout = client.status === 'æœåŠ¡ä¸­' ? 15000 : 5000;
            setTimeout(notification.close.bind(notification), timeout);
        }

        // æ–°å¢ï¼šé¡µé¢æ ‡é¢˜é—ªçƒ
        function startTitleBlink() {
            if (titleBlinkInterval) return;
            
            originalTitle = document.title;
            let blinkState = true;
            
            titleBlinkInterval = setInterval(() => {
                if (blinkState) {
                    document.title = 'ğŸš¨ è½®åˆ°æ‚¨äº†ï¼è¯·è¿›å…¥ä¼šè®®å®¤ - ' + originalTitle;
                } else {
                    document.title = originalTitle;
                }
                blinkState = !blinkState;
            }, 1000);
        }

        function stopTitleBlink() {
            if (titleBlinkInterval) {
                clearInterval(titleBlinkInterval);
                titleBlinkInterval = null;
                document.title = originalTitle;
            }
        }

        // æ–°å¢ï¼šæ’­æ”¾é€šçŸ¥å£°éŸ³
        function playNotificationSound() {
            const audio = document.getElementById('notification-sound');
            if (audio) {
                audio.currentTime = 0;
                audio.play().catch(e => {
                    console.log('æ— æ³•æ’­æ”¾é€šçŸ¥å£°éŸ³:', e);
                    // ä½¿ç”¨ Web Audio API ä½œä¸ºå¤‡ç”¨æ–¹æ¡ˆ
                    playFallbackSound();
                });
            } else {
                playFallbackSound();
            }
        }

        function playFallbackSound() {
            if (!window.AudioContext && !window.webkitAudioContext) return;
            
            const audioContext = new (window.AudioContext || window.webkitAudioContext)();
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            gainNode.gain.setValueAtTime(0, audioContext.currentTime);
            gainNode.gain.linearRampToValueAtTime(0.3, audioContext.currentTime + 0.1);
            gainNode.gain.linearRampToValueAtTime(0, audioContext.currentTime + 0.3);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.3);
        }

        // æ–°å¢ï¼šé¡µé¢å†…é€šçŸ¥
        function showInPageNotification(message) {
            const notification = document.createElement('div');
            notification.className = 'notification-toast';
            notification.innerHTML = `
                <div style="display: flex; align-items: center; gap: 15px;">
                    <i class="fas fa-bell" style="color: #FFD700;"></i>
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // è‡ªå®šä¹‰ç¡®è®¤å¯¹è¯æ¡†å‡½æ•°
        function showConfirmDialog(message, callback) {
            document.getElementById('confirm-message').textContent = message;
            document.getElementById('custom-confirm').style.display = 'flex';
            pendingConfirmCallback = callback;
        }

        function hideConfirmDialog() {
            document.getElementById('custom-confirm').style.display = 'none';
            pendingConfirmCallback = null;
        }
        
        function toggleTextSize() {
            isLargeText = !isLargeText;
            document.body.classList.toggle('small-text', !isLargeText);
            localStorage.setItem('clientLargeText', isLargeText);
            updateTextSizeToggle(isLargeText);
        }
        
        function updateTextSizeToggle(isLarge) {
            const button = document.getElementById('text-size-toggle');
            if (isLarge) {
                button.title = 'åˆ‡æ¢ä¸ºå°å­—ä½“';
                button.innerHTML = '<i class="fas fa-text-width"></i>';
            } else {
                button.title = 'åˆ‡æ¢ä¸ºå¤§å­—ä½“';
                button.innerHTML = '<i class="fas fa-text-height"></i>';
            }
        }
        
        function loadSettings() {
            showLoading('è½½å…¥ç³»ç»Ÿè®¾å®šä¸­...');
            
            google.script.run
                .withSuccessHandler(settings => {
                    const lightDisplay = document.getElementById('light-type-display');
                    const lightType = settings.TODAY_LIGHT || 'å…‰æ˜ç¯';
                    
                    lightDisplay.innerHTML = `
                        <i class="fas fa-lightbulb"></i> ${lightType}
                        <div style="font-size: 1.1rem; color: #666; margin-top: 10px;">
                        è‡ªåŠ¨å®¡æ ¸ä¸­
                        </div>
                    `;
                    
                    hideLoading();
                })
                .withFailureHandler(error => {
                    const lightDisplay = document.getElementById('light-type-display');
                    lightDisplay.innerHTML = `
                        <i class="fas fa-lightbulb"></i> å…‰æ˜ç¯
                        <div style="font-size: 1.1rem; color: #666; margin-top: 10px;">
                        è‡ªåŠ¨å®¡æ ¸ä¸­
                        </div>
                    `;
                    hideLoading();
                })
                .getMeetingSettings();
        }
        
        function submitApplication() {
            const name = document.getElementById('client-name').value.trim();
            
            if (!name) {
                showAlert('è¯·å¡«å†™çœŸå®å§“å', 'danger');
                document.getElementById('client-name').focus();
                return;
            }
            
            if (selectedNotes.length === 0) {
                showAlert('è¯·è‡³å°‘é€‰æ‹©ä¸€é¡¹æ³¨æ„äº‹é¡¹', 'danger');
                return;
            }
            
            showLoading('æäº¤ç”³è¯·ä¸­...');
            
            const clientData = {
                name: name,
                notes: selectedNotes,
                clientId: currentClient ? currentClient.clientId : null
            };
            
            google.script.run
                .withSuccessHandler(result => {
                    if (result.error) {
                        showAlert(result.error, 'danger');
                    } else if (result.existing) {
                        // æ¢å¤ç°æœ‰ç”³è¯·
                        currentClient = { name: name, ...result };
                        showWaitingState(result);
                        startStatusRefresh();
                        startNotificationCheck();
                        showAlert('å·²æ¢å¤æ‚¨çš„ç”³è¯·çŠ¶æ€', 'info');
                    } else {
                        currentClient = { name: name, ...result };
                        
                        // å‚¨å­˜å®¢æˆ·èµ„æ–™åˆ°æœ¬åœ°
                        const clientDataToStore = {
                            name: name,
                            clientId: result.clientId,
                            status: result.status,
                            lightType: result.lightType,
                            timestamp: new Date().getTime()
                        };
                        localStorage.setItem('clientData', JSON.stringify(clientDataToStore));
                        
                        showApplicationResult(result);
                        startStatusRefresh();
                        startNotificationCheck();
                    }
                    hideLoading();
                })
                .withFailureHandler(error => {
                    console.error('æäº¤å¤±è´¥:', error);
                    showAlert('æäº¤å¤±è´¥: ' + error.message, 'danger');
                    hideLoading();
                })
                .submitApplication(clientData);
        }
        
        function showApplicationResult(result) {
            document.getElementById('application-form').style.display = 'none';
            document.getElementById('waiting-area').style.display = 'block';
            
            updateClientStatusDisplay(result);
            showAlert(result.message, result.status === 'ç­‰å¾…ä¸­' ? 'success' : 'warning');
        }
        
        function showWaitingState(result) {
            document.getElementById('application-form').style.display = 'none';
            document.getElementById('waiting-area').style.display = 'block';
            updateClientStatusDisplay(result);
        }
        
        function updateClientStatusDisplay(result) {
            const statusBadge = document.getElementById('status-badge');
            statusBadge.textContent = result.status;
            statusBadge.className = 'status-badge ' + getStatusClass(result.status);
            
            const positionInfo = document.getElementById('current-position-info');
            const meetingLink = document.getElementById('meeting-link');
            const queueListContainer = document.getElementById('queue-list-container');
            const refreshInfo = document.getElementById('auto-refresh-info');
            const retrySection = document.getElementById('retry-section');
            const cancelSection = document.getElementById('cancel-section');
            
            // éšè—é‡æ–°æŠ¥åå’Œå–æ¶ˆæŒ‰é’®ï¼ˆé»˜è®¤ï¼‰
            retrySection.style.display = 'none';
            cancelSection.style.display = 'none';
            
            if (result.status === 'ç­‰å¾…ä¸­') {
                const queueNum = result.queue_num || '-';
                if (queueNum === 1) {
                    positionInfo.innerHTML = '<i class="fas fa-check-circle"></i> æ‚¨æ˜¯ç¬¬ä¸€ä½ï¼Œè¯·å‡†å¤‡è¿›å…¥ä¼šè®®å®¤';
                    positionInfo.style.color = '#228B22';
                } else if (queueNum > 1) {
                    positionInfo.innerHTML = `<i class="fas fa-clock"></i> æ‚¨å‰é¢è¿˜æœ‰ ${queueNum - 1} ä½ç­‰å¾…è€…`;
                    positionInfo.style.color = '#FF8C00';
                } else {
                    positionInfo.innerHTML = '<i class="fas fa-clock"></i> è¯·ç­‰å¾…ç®¡ç†å‘˜å®‰æ’';
                    positionInfo.style.color = '#FF8C00';
                }
                document.getElementById('queue-number').textContent = queueNum;
                meetingLink.style.display = 'none';
                meetingLink.classList.add('disabled');
                meetingLink.classList.remove('pulse', 'active');
                meetingLink.removeAttribute('href');
                queueListContainer.style.display = 'block';
                refreshInfo.style.display = 'block';
                cancelSection.style.display = 'block';
            } else if (result.status === 'æœåŠ¡ä¸­') {
                positionInfo.innerHTML = '<i class="fas fa-check-circle"></i> è¯·å‡†å¤‡è¿›å…¥ä¼šè®®å®¤';
                positionInfo.style.color = '#228B22';
                document.getElementById('queue-number').textContent = result.queue_num || 'æœåŠ¡ä¸­';
                
                // é‡è¦ä¿®æ”¹ï¼šç«‹å³åŠ è½½ä¼šè®®é“¾æ¥
                loadMeetingLink();
                meetingLink.style.display = 'block';
                meetingLink.classList.remove('disabled');
                meetingLink.classList.add('active', 'pulse');
                queueListContainer.style.display = 'block';
                refreshInfo.style.display = 'block';
                
                // è§¦å‘å¼ºåŠ›é€šçŸ¥
                triggerPowerfulNotification(result);
            } else if (result.status === 'ç»“æŸ') {
                positionInfo.innerHTML = '<i class="fas fa-check-circle"></i> æœåŠ¡å·²ç»“æŸï¼Œæ„Ÿè°¢æ‚¨ï¼';
                positionInfo.style.color = '#6c757d';
                document.getElementById('queue-number').textContent = 'å·²ç»“æŸ';
                meetingLink.style.display = 'block';
                meetingLink.classList.add('disabled');
                meetingLink.classList.remove('active', 'pulse');
                meetingLink.innerHTML = '<i class="fas fa-video-slash"></i> æœåŠ¡å·²ç»“æŸ';
                meetingLink.removeAttribute('href');
                queueListContainer.style.display = 'none';
                refreshInfo.style.display = 'none';
                hasMeetingEnded = true;
                stopStatusRefresh();
                stopNotificationCheck();
                stopTitleBlink();
                
                // æ¸…é™¤æœ¬åœ°å‚¨å­˜
                localStorage.removeItem('clientData');
            } else if (result.status === 'æœªé€šè¿‡') {
                positionInfo.innerHTML = `<i class="fas fa-times-circle"></i> ${result.message || 'å®¡æ ¸æœªé€šè¿‡'}`;
                positionInfo.style.color = '#e74c3c';
                document.getElementById('queue-number').textContent = 'æœªé€šè¿‡';
                meetingLink.style.display = 'none';
                meetingLink.classList.remove('pulse');
                meetingLink.removeAttribute('href');
                queueListContainer.style.display = 'none';
                refreshInfo.style.display = 'none';
                stopNotificationCheck();
                stopTitleBlink();
                
                // æ˜¾ç¤ºé‡æ–°æŠ¥åæŒ‰é’®
                retrySection.style.display = 'block';
                stopStatusRefresh();
            } else if (result.status === 'å·²å–æ¶ˆ') {
                positionInfo.innerHTML = '<i class="fas fa-times-circle"></i> æŠ¥åå·²å–æ¶ˆ';
                positionInfo.style.color = '#6c757d';
                document.getElementById('queue-number').textContent = 'å·²å–æ¶ˆ';
                meetingLink.style.display = 'none';
                meetingLink.classList.remove('pulse');
                meetingLink.removeAttribute('href');
                queueListContainer.style.display = 'none';
                refreshInfo.style.display = 'none';
                stopNotificationCheck();
                stopTitleBlink();
                
                // æ˜¾ç¤ºé‡æ–°æŠ¥åæŒ‰é’®
                retrySection.style.display = 'block';
                stopStatusRefresh();
            }
        }

        function showCancelConfirm() {
            if (!currentClient || !currentClient.clientId) {
                showAlert('æ— æ³•å–æ¶ˆæŠ¥åï¼Œè¯·é‡æ–°æ•´ç†é¡µé¢åå†è¯•', 'danger');
                return;
            }
            
            showConfirmDialog('ç¡®å®šè¦å–æ¶ˆæŠ¥åå—ï¼Ÿå–æ¶ˆåå°†æ— æ³•æ¢å¤æ‚¨çš„æ’é˜Ÿä½ç½®ã€‚', cancelApplication);
        }
        
        function cancelApplication() {
            showLoading('å–æ¶ˆæŠ¥åä¸­...');
            
            google.script.run
                .withSuccessHandler(result => {
                    if (result.error) {
                        showAlert('å–æ¶ˆæŠ¥åå¤±è´¥: ' + result.error, 'danger');
                    } else {
                        showAlert(result.message, 'success');
                        stopStatusRefresh();
                        stopNotificationCheck();
                        stopTitleBlink();
                        localStorage.removeItem('clientData');
                        
                        // æ›´æ–°æ˜¾ç¤ºçŠ¶æ€
                        document.getElementById('status-badge').textContent = 'å·²å–æ¶ˆ';
                        document.getElementById('status-badge').className = 'status-badge status-cancelled';
                        document.getElementById('current-position-info').innerHTML = '<i class="fas fa-times-circle"></i> æŠ¥åå·²å–æ¶ˆ';
                        document.getElementById('current-position-info').style.color = '#6c757d';
                        document.getElementById('queue-number').textContent = 'å·²å–æ¶ˆ';
                        document.getElementById('queue-list-container').style.display = 'none';
                        document.getElementById('auto-refresh-info').style.display = 'none';
                        document.getElementById('cancel-section').style.display = 'none';
                        document.getElementById('retry-section').style.display = 'block';
                    }
                    hideLoading();
                })
                .withFailureHandler(error => {
                    console.error('å–æ¶ˆæŠ¥åå¤±è´¥:', error);
                    showAlert('å–æ¶ˆæŠ¥åå¤±è´¥: ' + error.message, 'danger');
                    hideLoading();
                })
                .cancelApplication(currentClient.clientId);
        }
        
        function retryApplication() {
            // æ¸…é™¤æœ¬åœ°å‚¨å­˜å’Œå½“å‰å®¢æˆ·èµ„æ–™
            localStorage.removeItem('clientData');
            currentClient = null;
            selectedNotes = [];
            
            // é‡ç½®è¡¨å•
            document.getElementById('client-name').value = '';
            document.querySelectorAll('.note-tag').forEach(tag => {
                tag.classList.remove('active');
            });
            
            // æ˜¾ç¤ºç”³è¯·è¡¨å•
            document.getElementById('waiting-area').style.display = 'none';
            document.getElementById('application-form').style.display = 'block';
            document.getElementById('alert-area').innerHTML = '';
            
            // èšç„¦åˆ°å§“åè¾“å…¥æ¡†
            document.getElementById('client-name').focus();
        }
        
        function startStatusRefresh() {
            if (!currentClient) return;
            
            loadWaitingQueue();
            if (!refreshInterval) {
                refreshInterval = setInterval(loadWaitingQueue, 3000);
            }
        }
        
        function stopStatusRefresh() {
            if (refreshInterval) {
                clearInterval(refreshInterval);
                refreshInterval = null;
            }
        }

        function stopNotificationCheck() {
            if (notificationCheckInterval) {
                clearInterval(notificationCheckInterval);
                notificationCheckInterval = null;
            }
        }
        
        function loadWaitingQueue() {
            if (!currentClient) return;
            
            google.script.run
                .withSuccessHandler(data => {
                    displayQueue(data);
                    
                    if (data.client) {
                        // æ›´æ–°å®¢æˆ·çŠ¶æ€
                        const updatedClient = {
                            ...currentClient,
                            status: data.client.status,
                            queue_num: data.client.queue_num
                        };
                        
                        // æ›´æ–°æœ¬åœ°å‚¨å­˜
                        const clientDataToStore = {
                            name: updatedClient.name,
                            clientId: updatedClient.clientId,
                            status: updatedClient.status,
                            lightType: updatedClient.lightType,
                            timestamp: new Date().getTime()
                        };
                        localStorage.setItem('clientData', JSON.stringify(clientDataToStore));
                        
                        updateClientStatusFromQueue(data.client, data.list);
                    } else {
                        // å¦‚æœæ‰¾ä¸åˆ°å®¢æˆ·èµ„æ–™ï¼Œæ˜¾ç¤ºæœªæŠ¥åçŠ¶æ€
                        document.getElementById('application-form').style.display = 'block';
                        document.getElementById('waiting-area').style.display = 'none';
                        showAlert('æ‰¾ä¸åˆ°æ‚¨çš„æŠ¥åèµ„æ–™ï¼Œè¯·é‡æ–°æŠ¥å', 'warning');
                        stopStatusRefresh();
                        stopNotificationCheck();
                        stopTitleBlink();
                        localStorage.removeItem('clientData');
                    }
                })
                .withFailureHandler(error => {
                    console.error('è½½å…¥é˜Ÿåˆ—å¤±è´¥:', error);
                    displayQueue({ list: [] });
                })
                .getWaitingList(currentClient.name, currentClient.clientId);
        }
        
        function displayQueue(data) {
            const queueListContent = document.getElementById('queue-list-content');
            const list = data.list || [];
            const queueListContainer = document.getElementById('queue-list-container');
            
            if (list.length > 0) {
                queueListContainer.style.display = 'block';
                
                let html = '';
                
                list.forEach(item => {
                    const statusClass = getStatusClass(item.status);
                    const isCurrentUser = currentClient && item.is_client;
                    
                    const itemClass = isCurrentUser ? 'queue-item current-user' : 'queue-item';
                    
                    html += `
                        <div class="${itemClass}" style="display: flex; justify-content: space-between; align-items: center; padding: 18px; border-bottom: 2px solid #eee; background: #f9f9f9; margin-bottom: 12px; border-radius: 10px; font-size: 1.3rem;">
                            <div>
                                <strong>${item.queue_num || ''}å·</strong> - ${item.display_name || 'æœªçŸ¥'}
                                ${isCurrentUser ? '<span style="color: #FF8C00; margin-left: 10px; font-weight: 600;">(æ‚¨)</span>' : ''}
                            </div>
                            <div class="status-badge ${statusClass}">${item.status || 'æœªçŸ¥'}</div>
                        </div>
                    `;
                });
                
                queueListContent.innerHTML = html;
            } else {
                queueListContainer.style.display = 'none';
                queueListContent.innerHTML = '<p style="text-align: center; padding: 20px; font-size: 1.3rem;">ç›®å‰æ²¡æœ‰ç­‰å¾…ä¸­çš„å®¢æˆ·</p>';
            }
        }
        
        function updateClientStatusFromQueue(client, list) {
            document.getElementById('application-form').style.display = 'none';
            document.getElementById('waiting-area').style.display = 'block';
            
            if (client.queue_num) {
                document.getElementById('queue-number').textContent = client.queue_num;
            } else {
                document.getElementById('queue-number').textContent = '-';
            }
            
            const statusBadge = document.getElementById('status-badge');
            statusBadge.textContent = client.status;
            statusBadge.className = 'status-badge ' + getStatusClass(client.status);
            
            const positionInfo = document.getElementById('current-position-info');
            const meetingLink = document.getElementById('meeting-link');
            const queueListContainer = document.getElementById('queue-list-container');
            const refreshInfo = document.getElementById('auto-refresh-info');
            const retrySection = document.getElementById('retry-section');
            const cancelSection = document.getElementById('cancel-section');
            
            retrySection.style.display = 'none';
            cancelSection.style.display = 'none';
            
            if (client.status === 'ç­‰å¾…ä¸­') {
                const queueNum = client.queue_num;
                if (queueNum === 1) {
                    positionInfo.innerHTML = '<i class="fas fa-check-circle"></i> æ‚¨æ˜¯ç¬¬ä¸€ä½ï¼Œè¯·å‡†å¤‡è¿›å…¥ä¼šè®®å®¤';
                    positionInfo.style.color = '#228B22';
                } else if (queueNum > 1) {
                    positionInfo.innerHTML = `<i class="fas fa-clock"></i> æ‚¨å‰é¢è¿˜æœ‰ ${queueNum - 1} ä½ç­‰å¾…è€…`;
                    positionInfo.style.color = '#FF8C00';
                } else {
                    positionInfo.innerHTML = '<i class="fas fa-clock"></i> è¯·ç­‰å¾…ç®¡ç†å‘˜å®‰æ’';
                    positionInfo.style.color = '#FF8C00';
                }
                meetingLink.style.display = 'none';
                meetingLink.classList.add('disabled');
                meetingLink.classList.remove('active', 'pulse');
                meetingLink.removeAttribute('href');
                queueListContainer.style.display = 'block';
                refreshInfo.style.display = 'block';
                cancelSection.style.display = 'block';
            } else if (client.status === 'æœåŠ¡ä¸­') {
                positionInfo.innerHTML = '<i class="fas fa-check-circle"></i> è¯·å‡†å¤‡è¿›å…¥ä¼šè®®å®¤';
                positionInfo.style.color = '#228B22';
                
                // é‡è¦ä¿®æ”¹ï¼šç«‹å³åŠ è½½ä¼šè®®é“¾æ¥
                loadMeetingLink();
                meetingLink.style.display = 'block';
                meetingLink.classList.remove('disabled');
                meetingLink.classList.add('active', 'pulse');
                queueListContainer.style.display = 'block';
                refreshInfo.style.display = 'block';
                
                // æ£€æŸ¥æ˜¯å¦éœ€è¦è§¦å‘é€šçŸ¥
                if (lastKnownStatus !== 'æœåŠ¡ä¸­') {
                    triggerPowerfulNotification(client);
                }
            } else if (client.status === 'ç»“æŸ') {
                positionInfo.innerHTML = '<i class="fas fa-check-circle"></i> æœåŠ¡å·²ç»“æŸï¼Œæ„Ÿè°¢æ‚¨ï¼';
                positionInfo.style.color = '#6c757d';
                meetingLink.style.display = 'block';
                meetingLink.classList.add('disabled');
                meetingLink.classList.remove('active', 'pulse');
                meetingLink.innerHTML = '<i class="fas fa-video-slash"></i> æœåŠ¡å·²ç»“æŸ';
                meetingLink.removeAttribute('href');
                queueListContainer.style.display = 'none';
                refreshInfo.style.display = 'none';
                hasMeetingEnded = true;
                stopStatusRefresh();
                stopNotificationCheck();
                stopTitleBlink();
                localStorage.removeItem('clientData');
            } else if (client.status === 'æœªé€šè¿‡') {
                positionInfo.innerHTML = '<i class="fas fa-times-circle"></i> å®¡æ ¸æœªé€šè¿‡';
                positionInfo.style.color = '#e74c3c';
                meetingLink.style.display = 'none';
                meetingLink.classList.remove('pulse');
                meetingLink.removeAttribute('href');
                queueListContainer.style.display = 'none';
                refreshInfo.style.display = 'none';
                retrySection.style.display = 'block';
                stopStatusRefresh();
                stopNotificationCheck();
                stopTitleBlink();
            } else if (client.status === 'å·²å–æ¶ˆ') {
                positionInfo.innerHTML = '<i class="fas fa-times-circle"></i> æŠ¥åå·²å–æ¶ˆ';
                positionInfo.style.color = '#6c757d';
                meetingLink.style.display = 'none';
                meetingLink.classList.remove('pulse');
                meetingLink.removeAttribute('href');
                queueListContainer.style.display = 'none';
                refreshInfo.style.display = 'none';
                retrySection.style.display = 'block';
                stopStatusRefresh();
                stopNotificationCheck();
                stopTitleBlink();
            }
            
            // æ›´æ–°æœ€åå·²çŸ¥çŠ¶æ€
            lastKnownStatus = client.status;
            lastKnownQueueNum = client.queue_num || 0;
        }
        
        // é‡è¦ä¿®æ”¹ï¼šç®€åŒ–ä¼šè®®é“¾æ¥åŠ è½½
        function loadMeetingLink() {
            google.script.run
                .withSuccessHandler(settings => {
                    if (settings && settings.LINE_MEETING_LINK) {
                        const meetingLink = document.getElementById('meeting-link');
                        // ç›´æ¥è®¾ç½®hrefå±æ€§ï¼Œè®©æµè§ˆå™¨è‡ªç„¶å¤„ç†
                        meetingLink.href = settings.LINE_MEETING_LINK;
                        meetingLink.innerHTML = '<i class="fas fa-video"></i> è¿›å…¥ Line ä¼šè®®å®¤';
                    } else {
                        showAlert('ä¼šè®®å®¤é“¾æ¥å°šæœªè®¾å®šï¼Œè¯·è”ç³»ç®¡ç†å‘˜', 'warning');
                    }
                })
                .withFailureHandler(error => {
                    console.error('è½½å…¥ä¼šè®®é“¾æ¥å¤±è´¥:', error);
                    showAlert('è½½å…¥ä¼šè®®å®¤é“¾æ¥å¤±è´¥ï¼Œè¯·ç¨åå†è¯•', 'danger');
                })
                .getMeetingSettings();
        }
        
        function getStatusClass(status) {
            switch(status) {
                case 'å®¡æ ¸ä¸­': return 'status-pending';
                case 'ç­‰å¾…ä¸­': return 'status-waiting';
                case 'æœåŠ¡ä¸­': return 'status-serving';
                case 'ç»“æŸ': return 'status-completed';
                case 'æœªé€šè¿‡': return 'status-rejected';
                case 'å·²å–æ¶ˆ': return 'status-cancelled';
                default: return 'status-pending';
            }
        }
        
        function showAlert(message, type) {
            const alertArea = document.getElementById('alert-area');
            const icon = type === 'success' ? 'fa-check-circle' :
                        type === 'danger' ? 'fa-exclamation-triangle' :
                        type === 'warning' ? 'fa-clock' : 'fa-info-circle';
            
            const alertClass = type === 'success' ? 'alert-success' :
                              type === 'danger' ? 'alert-danger' :
                              type === 'warning' ? 'alert-warning' : 'alert-info';
            
            alertArea.innerHTML = `
                <div class="alert ${alertClass}" style="padding: 18px; border-radius: 12px; margin-bottom: 15px; text-align: center; font-size: 1.4rem; min-height: 65px; display: flex; align-items: center; justify-content: center; background: ${type === 'success' ? '#d4edda' : type === 'danger' ? '#f8d7da' : type === 'warning' ? '#fff3cd' : '#d1ecf1'}; color: ${type === 'success' ? '#155724' : type === 'danger' ? '#721c24' : type === 'warning' ? '#856404' : '#0c5460'}; border: 2px solid ${type === 'success' ? '#c3e6cb' : type === 'danger' ? '#f5c6cb' : type === 'warning' ? '#ffeaa7' : '#bee5eb'};">
                    <i class="fas ${icon}"></i>
                    ${message}
                </div>
            `;
            
            const clearTime = type === 'success' ? 5000 : 3000;
            setTimeout(() => {
                if (alertArea.innerHTML.includes(message)) {
                    alertArea.innerHTML = '';
                }
            }, clearTime);
        }
        
        function showLoading(message) {
            const alertArea = document.getElementById('alert-area');
            alertArea.innerHTML = `
                <div class="alert alert-info" style="padding: 18px; border-radius: 12px; margin-bottom: 15px; text-align: center; font-size: 1.4rem; min-height: 65px; display: flex; align-items: center; justify-content: center; background: #d1ecf1; color: #0c5460; border: 2px solid #bee5eb;">
                    <i class="fas fa-spinner fa-spin"></i> ${message}
                </div>
            `;
        }
        
        function hideLoading() {
            // è½½å…¥çŠ¶æ€ä¼šè‡ªåŠ¨è¢«å…¶ä»–å†…å®¹æ›¿æ¢
        }
    </script>
</body>
</html>
